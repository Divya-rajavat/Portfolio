{"ast":null,"code":"'use strict';\n\nvar as = require('../../lib/as.js');\nvar debug = require('debug')('express-http-proxy');\nvar zlib = require('zlib');\nfunction isResGzipped(res) {\n  return res.headers['content-encoding'] === 'gzip';\n}\nfunction zipOrUnzip(method) {\n  return function (rspData, res) {\n    return new Promise(function (resolve, reject) {\n      if (isResGzipped(res) && rspData.length) {\n        zlib[method](rspData, function (err, buffer) {\n          if (err) {\n            reject(err);\n          } else {\n            resolve(buffer);\n          }\n        });\n      } else {\n        resolve(rspData);\n      }\n    });\n  };\n}\nvar maybeUnzipPromise = zipOrUnzip('gunzip');\nvar maybeZipPromise = zipOrUnzip('gzip');\nfunction verifyBuffer(rspd, reject) {\n  if (!Buffer.isBuffer(rspd)) {\n    return reject(new Error('userResDecorator should return string or buffer as data'));\n  }\n}\nfunction updateHeaders(res, rspdBefore, rspdAfter, reject) {\n  if (!res.headersSent) {\n    res.set('content-length', rspdAfter.length);\n  } else if (rspdAfter.length !== rspdBefore.length) {\n    var error = '\"Content-Length\" is already sent,' + 'the length of response data can not be changed';\n    return reject(new Error(error));\n  }\n}\nfunction decorateProxyResBody(container) {\n  var resolverFn = container.options.userResDecorator;\n  if (!resolverFn) {\n    return Promise.resolve(container);\n  }\n  var proxyResDataPromise = maybeUnzipPromise(container.proxy.resData, container.proxy.res);\n  var proxyRes = container.proxy.res;\n  var req = container.user.req;\n  var res = container.user.res;\n  var originalResData;\n  if (res.statusCode === 304) {\n    debug('Skipping userResDecorator on response 304');\n    return Promise.resolve(container);\n  }\n  return proxyResDataPromise.then(function (proxyResData) {\n    originalResData = proxyResData;\n    return resolverFn(proxyRes, proxyResData, req, res);\n  }).then(function (modifiedResData) {\n    return new Promise(function (resolve, reject) {\n      var rspd = as.buffer(modifiedResData, container.options);\n      verifyBuffer(rspd, reject);\n      updateHeaders(res, originalResData, rspd, reject);\n      maybeZipPromise(rspd, container.proxy.res).then(function (buffer) {\n        container.proxy.resData = buffer;\n        resolve(container);\n      }).catch(function (error) {\n        reject(error);\n      });\n    });\n  });\n}\nmodule.exports = decorateProxyResBody;","map":{"version":3,"names":["as","require","debug","zlib","isResGzipped","res","headers","zipOrUnzip","method","rspData","Promise","resolve","reject","length","err","buffer","maybeUnzipPromise","maybeZipPromise","verifyBuffer","rspd","Buffer","isBuffer","Error","updateHeaders","rspdBefore","rspdAfter","headersSent","set","error","decorateProxyResBody","container","resolverFn","options","userResDecorator","proxyResDataPromise","proxy","resData","proxyRes","req","user","originalResData","statusCode","then","proxyResData","modifiedResData","catch","module","exports"],"sources":["E:/CLG/Projects/my_portfolio/node_modules/express-http-proxy/app/steps/decorateUserRes.js"],"sourcesContent":["'use strict';\n\nvar as = require('../../lib/as.js');\nvar debug = require('debug')('express-http-proxy');\nvar zlib = require('zlib');\n\nfunction isResGzipped(res) {\n  return res.headers['content-encoding'] === 'gzip';\n}\n\nfunction zipOrUnzip(method) {\n  return function (rspData, res) {\n    return new Promise(function (resolve, reject) {\n      if (isResGzipped(res) && rspData.length) {\n        zlib[method](rspData, function (err, buffer) {\n          if (err) {\n            reject(err);\n          } else {\n            resolve(buffer);\n          }\n        });\n      } else {\n        resolve(rspData);\n      }\n    });\n  };\n}\n\nvar maybeUnzipPromise = zipOrUnzip('gunzip');\nvar maybeZipPromise = zipOrUnzip('gzip');\n\nfunction verifyBuffer(rspd, reject) {\n  if (!Buffer.isBuffer(rspd)) {\n    return reject(new Error('userResDecorator should return string or buffer as data'));\n  }\n}\n\nfunction updateHeaders(res, rspdBefore, rspdAfter, reject) {\n  if (!res.headersSent) {\n    res.set('content-length', rspdAfter.length);\n  } else if (rspdAfter.length !== rspdBefore.length) {\n    var error = '\"Content-Length\" is already sent,' +\n          'the length of response data can not be changed';\n    return reject(new Error(error));\n  }\n}\n\nfunction decorateProxyResBody(container) {\n  var resolverFn = container.options.userResDecorator;\n\n  if (!resolverFn) {\n    return Promise.resolve(container);\n  }\n\n  var proxyResDataPromise = maybeUnzipPromise(container.proxy.resData, container.proxy.res);\n  var proxyRes = container.proxy.res;\n  var req = container.user.req;\n  var res = container.user.res;\n  var originalResData;\n\n  if (res.statusCode === 304) {\n    debug('Skipping userResDecorator on response 304');\n    return Promise.resolve(container);\n  }\n\n  return proxyResDataPromise\n    .then(function (proxyResData) {\n      originalResData = proxyResData;\n      return resolverFn(proxyRes, proxyResData, req, res);\n    })\n    .then(function (modifiedResData) {\n      return new Promise(function (resolve, reject) {\n        var rspd = as.buffer(modifiedResData, container.options);\n        verifyBuffer(rspd, reject);\n        updateHeaders(res, originalResData, rspd, reject);\n        maybeZipPromise(rspd, container.proxy.res).then(function (buffer) {\n          container.proxy.resData = buffer;\n          resolve(container);\n        }).catch(function (error) {\n          reject(error);\n        });\n      });\n    });\n}\n\nmodule.exports = decorateProxyResBody;\n"],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}